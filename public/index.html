<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é²¸æ™“é¸£ - æ•…éšœè¯Šæ–­ç‰ˆ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body class="bg-slate-50">
    <div class="max-w-xl mx-auto mt-20 p-6 bg-white rounded-xl shadow-lg border border-red-100">
        <h2 class="text-xl font-bold text-gray-800 mb-4 flex items-center gap-2">
            <i class="fa-solid fa-stethoscope text-red-500"></i> ç³»ç»Ÿè¿é€šæ€§è¯Šæ–­
        </h2>
        
        <div id="upload-zone" class="border-2 border-dashed border-gray-300 rounded-xl p-8 text-center mb-6">
            <input type="file" id="file-input" class="block w-full text-sm text-slate-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100 mb-4"/>
            <button id="start-btn" onclick="runDiagnostic()" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 rounded-lg transition-colors">
                å¼€å§‹è¯Šæ–­å¹¶ä¸Šä¼ 
            </button>
        </div>

        <div id="debug-log" class="bg-gray-900 text-green-400 p-4 rounded-lg font-mono text-xs overflow-x-auto whitespace-pre-wrap hidden"></div>
    </div>

    <script type="module">
        import { upload } from 'https://esm.sh/@vercel/blob@0.23.0/client';

        window.runDiagnostic = async function() {
            const fileInput = document.getElementById('file-input');
            const logEl = document.getElementById('debug-log');
            
            if (!fileInput.files[0]) {
                alert("è¯·å…ˆé€‰æ‹©ä¸€ä¸ªè§†é¢‘æ–‡ä»¶ï¼");
                return;
            }

            const file = fileInput.files[0];
            logEl.classList.remove('hidden');
            logEl.innerText = "ğŸš€ å¼€å§‹è¯Šæ–­æµç¨‹...\n";

            function log(msg) {
                logEl.innerText += `[${new Date().toLocaleTimeString()}] ${msg}\n`;
            }

            try {
                // 1. ä¾¦å¯Ÿå…µï¼šæ‰‹åŠ¨æµ‹è¯• API è¿é€šæ€§
                log("ğŸ“¡ æ­¥éª¤1: æ­£åœ¨ Ping åç«¯æ¥å£ (/api/upload)...");
                
                const pingRes = await fetch('/api/upload', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    // å‘é€ä¸€ä¸ªå‡çš„æ¡æ‰‹åŒ…ï¼Œçœ‹çœ‹æœåŠ¡å™¨æ€ä¹ˆå›
                    body: JSON.stringify({ type: 'blob.generate-client-token', payload: {} }) 
                });

                log(`â¬…ï¸ æœåŠ¡å™¨çŠ¶æ€ç : ${pingRes.status} ${pingRes.statusText}`);
                
                const responseText = await pingRes.text();
                log(`ğŸ“„ æœåŠ¡å™¨åŸå§‹å“åº”: ${responseText.slice(0, 200)}...`); // åªæ˜¾ç¤ºå‰200å­—

                if (pingRes.status === 404) {
                    throw new Error("âŒ ä¸¥é‡æ•…éšœ: æ‰¾ä¸åˆ°æ¥å£ (404)ã€‚å¯èƒ½æ˜¯æ–‡ä»¶åä¸å¯¹ï¼Œæˆ–è€… Vercel è·¯ç”±æ²¡ç”Ÿæ•ˆã€‚");
                }
                if (pingRes.status === 500) {
                    throw new Error(`âŒ æœåŠ¡å™¨å†…éƒ¨é”™è¯¯ (500)ã€‚\nè¯·å» Vercel åå°çœ‹ Logsã€‚\né”™è¯¯è¯¦æƒ…: ${responseText}`);
                }
                if (!pingRes.ok) {
                    throw new Error(`âŒ æ¥å£å¼‚å¸¸ (${pingRes.status}): ${responseText}`);
                }

                log("âœ… æ¥å£è¿é€šæ€§æµ‹è¯•é€šè¿‡ï¼å‡†å¤‡è°ƒç”¨ SDK ä¸Šä¼ ...");

                // 2. æ­£å¼ä¸Šä¼ 
                const blob = await upload(file.name, file, {
                    access: 'public',
                    handleUploadUrl: '/api/upload',
                    onUploadProgress: (p) => log(`â³ ä¸Šä¼ è¿›åº¦: ${p.percentage}%`)
                });

                log(`ğŸ‰ ä¸Šä¼ æˆåŠŸï¼æ–‡ä»¶ URL:\n${blob.url}`);
                alert("æ­å–œï¼ä¸Šä¼ æˆåŠŸï¼é—®é¢˜å·²è§£å†³ã€‚");

            } catch (error) {
                console.error(error);
                log(`ğŸ’¥ æµç¨‹ç»ˆæ­¢: ${error.message}`);
                alert(`è¯Šæ–­å‘ç°é—®é¢˜ï¼š\n${error.message}`);
            }
        }
    </script>
</body>
</html>
