<script src="https://cdn.jsdelivr.net/npm/@vercel/blob@0.22.1/dist/index.js"></script>

<script>
    // 强制挂载到 window，确保按钮能点着
    window.handleUploadAndAnalyze = async function() {
        const fileInput = document.getElementById('file-input');
        const file = fileInput.files[0];
        if (!file) return alert("请先选择视频");

        const btn = document.getElementById('start-btn');
        btn.disabled = true;
        btn.innerText = "正在获取令牌...";

        try {
            // 使用全局 vercelBlob 变量
            const { upload } = vercelBlob; 
            
            const blob = await upload(file.name, file, {
                access: 'public',
                handleUploadUrl: '/api/upload',
                onUploadProgress: (p) => {
                    // 这里更新你的进度条
                    console.log("进度:", p.percentage);
                }
            });

            console.log("上传成功:", blob.url);
            btn.innerText = "分析中...";

            // 调用你的代理接口
            const res = await fetch('/api/proxy', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ videoUrl: blob.url })
            });
            const result = await res.json();
            // ... 渲染 Markdown 的逻辑 ...
            btn.innerText = "完成";

        } catch (error) {
            console.error(error);
            alert("出错啦: " + error.message);
            btn.disabled = false;
        }
    };
</script>
